<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Pedidos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <div class="logo"><b>PROJETO FASTAPI</b></div>
        <div class="links">
            <button onclick="logout()">Sair</button>            
        </div>        
        <strong>Gestão de Pedidos</strong>
    </nav>

    <div class="container">
        <form id="formPedido">
            <!--
            <h3>Novo Pedido</h3>
            <input type="text" id="title" placeholder="Título do Pedido" required>
            <input type="text" id="description" placeholder="Descrição">
            <button type="submit">Salvar Pedido</button>
            -->
        </form>

        <h3>Listagem de Pedidos</h3>
        <button onclick="novoPedido()">Novo Pedido</button>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Status</th>
                    <th>Preço</th>
                    <th>Editar</th>
                    <th>Excluir</th>
                </tr>
            </thead>
            <tbody id="lista"></tbody>
        </table>
        <h4>Itens do Pedido</h4>
        <table>
            <thead>
                <tr>
                    <th>Pedido</th>
                    <th>Sabor</th>
                    <th>Tamanho</th>
                    <th>Quantidade</th>
                    <th>Preço Unitario</th>
                    <th>Excluir</th>
                </tr>
            </thead>
            <tbody id="lista_itens"></tbody>
        </table>        
        <form id="inc_item" style="display: none;" class="login-card">
            <h2>Incluir Item</h2>
            <input type="number" id="quantidade" placeholder="Quantidade" required>
            <input type="text" id="sabor" placeholder="Sabor" required>
            <input type="text" id="tamanho" placeholder="Tamanho" required>
            <input type="number" id="preco_un" placeholder="Preço Unitário" required>
            <button type="submit">Incluir</button>
        </form>
    </div>    

    <script src="api.js"></script>
    <script>
        async function carregar() {
            const res = await OrderAPI.listar();
            const data = await res.json();
            document.getElementById('lista').innerHTML = data.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.status}</td>
                    <td>${p.preco}</td>
                    <td><button class="btn-edt" onclick="editar(${p.id})">Editar</button></td>
                    <td><button class="btn-del" onclick="deletar(${p.id})">Excluir</button></td>
                </tr>
            `).join('');
        }

        document.getElementById('formPedido').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value
            };
            await OrderAPI.criar(payload);
            carregar();
            e.target.reset();
        };

        async function deletar(id) {
            if(confirm("Confirma exclusão do pedido?")) {
                await OrderAPI.excluir_pedido(id);
                carregar();
            }
        }        

        async function editar(id) {     
            
            var table = document.getElementById("lista_itens");            
            while (table.rows.length > 0) {                
                document.getElementById("lista_itens").deleteRow(0)
            }
            
            const resIT = await OrderAPI.listar_itens(id);
            const dataIT = await resIT.json();            

            dataIT.forEach(dataIT => {
                var row = table.insertRow(0);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);
                var cell4 = row.insertCell(3);
                var cell5 = row.insertCell(4);
                var cell6 = row.insertCell(5);
                cell1.innerHTML = dataIT.pedido;                
                cell2.innerHTML = dataIT.sabor;
                cell3.innerHTML = dataIT.tamanho;
                cell4.innerHTML = dataIT.quantidade;
                cell5.innerHTML = dataIT.preco_unitario;   
                const btnExcluiIT = document.createElement("button");

                btnExcluiIT.innerHTML = "Excluir";
                btnExcluiIT.id = "btnExcluir";

                btnExcluiIT.addEventListener("click", function() {
                    //console.log(dataIT.id);
                    excluir_item(id, dataIT.id);
                    //await OrderAPI.excluir_item(id);
                });       

                cell6.appendChild(btnExcluiIT);
            });

            document.getElementById("inc_item").style.display = 'block'    
            
            document.getElementById('inc_item').onsubmit = async (e) => {
                e.preventDefault();
                const payload = {
                    quantidade: document.getElementById('quantidade').value,
                    sabor: document.getElementById('sabor').value,
                    tamanho: document.getElementById('tamanho').value,
                    preco_unitario: document.getElementById('preco_un').value
                };
                await OrderAPI.incluir_item(id, payload);
                carregar()
                editar(id)
                e.target.reset();
            };
        }        

        async function excluir_item(id, ITid) {
            await OrderAPI.excluir_item(ITid);
            carregar()
            editar(id)
        }

        async function novoPedido() {
            await OrderAPI.novo_pedido();
            carregar();
        }

        function logout() { localStorage.removeItem('access_token'); window.location.href="login.html"; }

        carregar();
    </script>
</body>
</html>